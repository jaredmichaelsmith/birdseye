<!doctype html>


<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Basic Viz</title>
  <meta name="description" content="Basic viz.">
  <meta name="author" content="Jared M. Smith">

  <link rel="stylesheet" href="{{ viz_css }}?v=1.0">  
  <link rel="stylesheet" href="{{ leaflet_css }}" />

  <!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>

<body>
    <h1>Here is a map!</h2>
    <div id="map"></div>
    <!--<button onclick="togglePlay()">Pause</button>-->

    <script src="{{ leaflet_js }}"></script>
    <script src="{{ d3_js  }}" charset="utf-8"></script>
    <script src="{{ leaflet_d3 }}" charset="utf-8"></script>
    <script src="{{ sock_js }}" charset="utf-8"></script>
    <script src="{{ stomp_js }}" charset="utf-8"></script>

    <script>

        // Define the center of the map.
        var center = [35.97, -83.94];

        // Get the basemap 'Dark Matter' from CartoDB and create the basemap layer.
        var basemapLayer = L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',{
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
        });

        // Create the map object.
        var map = L.map('map', {
            layers: [basemapLayer],
            scrollWheelZoom: true,
            center: new L.LatLng(center[0], center[1]),
            zoom: 6
        });

        // Configure a ping layer.
        var options = {
            lng: function(d){ return d[0]; },
            lat: function(d){ return d[1]; },
            duration: 800,
            efficient: {
                enabled: false,
                fps: 8
            }
        };

        // Create the ping layer and add it to the map.
        var pingLayer = L.pingLayer(options).addTo(map);

        // Change the radius and the opacity of the ping marker.
        pingLayer.radiusScale().range([2, 18]);
        pingLayer.opacityScale().range([1, 0]);


        // Establish a web socket connection through the STOMP protocol so that we can get data
        // from the Flask server.
        var ws = new SockJS('http://' + window.location.hostname + ':15674/stomp');
        var client = Stomp.over(ws);
        
        // Disable heartbeat functionality as it is not supported by this STOMP setup.
        client.heartbeat.incoming = 0;
        client.heartbeat.outgoing = 0;

        var on_error = function(error) {
            console.log('error');
        };

        var recv_message = function(message) {
            var jsonData = JSON.parse(message.body);
            pingLayer.ping([jsonData.lon, jsonData.lat]);       
        };
        

        var on_connect = function() {
            var subscription = client.subscribe("/amq/queue/twitter_sentiment_feed", recv_message); 
        };

        client.connect('guest', 'guest',  on_connect, on_error, '/');

        // Set random lat/lon pairs for coordinates.
        // var latFn = d3.random.normal(center[0], 1);
        // var longFn = d3.random.normal(center[1], 1);

        // Update function pings the map with random coordinates generated from above.
        /*var paused = false;
        var update = function() {
            if (!paused) {
                pingLayer.ping([longFn(), latFn()]);
                window.setTimeout(update, 100 + Math.random() * 400);
            }
        };
        
        // Let the pinging begin!
        window.setTimeout(update);

        // Toggles the pinging on or off.
        function togglePlay() {
            paused = !paused;
            d3.select('button').text((paused) ? 'Play' : 'Pause');

            if(!paused) {
                window.setTimeout(update);
            }
        }*/

    </script>
</body>
